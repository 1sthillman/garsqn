<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>TR QR Menü</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  <style>
    /* Neon Elite Arkaplan Tasarımı */
    :root {
      --neon-primary: #00ffff;
      --neon-secondary: #ff00ff;
      --neon-accent: #ffff00;
      --neon-glow: #0ff;
      --dark-bg: #0a0a0a;
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
    }

    /* Ana Arkaplan */
    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--dark-bg);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      position: relative;
    }

    /* Neon Arkaplan Katmanları */
    .neon-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }

    /* Gradient Arkaplan */
    .neon-bg-gradient {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(0, 255, 255, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 0, 255, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(255, 255, 0, 0.2) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
    }

    /* Neon Grid */
    .neon-grid {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: neon-grid-move 20s linear infinite;
    }

    @keyframes neon-grid-move {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    /* Neon Partiküller */
    .neon-particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--neon-primary);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--neon-primary);
      animation: particle-float 8s ease-in-out infinite;
    }

    .particle:nth-child(odd) {
      background: var(--neon-secondary);
      box-shadow: 0 0 10px var(--neon-secondary);
      animation-duration: 12s;
    }

    .particle:nth-child(3n) {
      background: var(--neon-accent);
      box-shadow: 0 0 10px var(--neon-accent);
      animation-duration: 10s;
    }

    @keyframes particle-float {
      0%, 100% { 
        transform: translateY(0px) translateX(0px);
        opacity: 0.3;
      }
      50% { 
        transform: translateY(-20px) translateX(10px);
        opacity: 1;
      }
    }

    /* Neon Kenarlar */
    .neon-border {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .neon-border::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--neon-primary), transparent);
      box-shadow: 0 0 20px var(--neon-primary);
    }

    .neon-border::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--neon-secondary), transparent);
      box-shadow: 0 0 20px var(--neon-secondary);
    }

    /* Glassmorphism Efektleri */
    .glass {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-header {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--neon-primary);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 24px;
      margin-bottom: 20px;
      border-radius: 16px;
    }

    /* Neon Butonlar */
    .neon-btn {
      background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 
        0 0 20px rgba(0, 255, 255, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .neon-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .neon-btn:hover::before {
      left: 100%;
    }

    .neon-btn:hover {
      transform: translateY(-2px);
      box-shadow: 
        0 0 30px rgba(0, 255, 255, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }

    /* Neon Kartlar */
    .neon-card {
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(15px);
      border: 1px solid var(--neon-primary);
      border-radius: 16px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(0, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .neon-card:hover {
      border-color: var(--neon-secondary);
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 30px rgba(255, 0, 255, 0.3);
      transform: translateY(-4px);
    }

    /* Neon Text */
    .neon-text {
      color: var(--neon-primary);
      text-shadow: 0 0 10px var(--neon-primary);
    }

    .neon-text-secondary {
      color: var(--neon-secondary);
      text-shadow: 0 0 10px var(--neon-secondary);
    }

    /* Ana Container */
    .main-container {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--neon-primary);
      text-shadow: 0 0 10px var(--neon-primary);
    }

    .table-number {
      background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    }

    /* Kategori Bar */
    .category-bar {
      display: flex;
      gap: 12px;
      padding: 16px;
      margin-bottom: 20px;
      overflow-x: auto;
      scrollbar-width: none;
    }

    .category-bar::-webkit-scrollbar {
      display: none;
    }

    .category-btn {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid var(--neon-primary);
      color: var(--neon-primary);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
    }

    .category-btn.active,
    .category-btn:hover {
      background: var(--neon-primary);
      color: black;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
    }

    /* Ürün Grid */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      padding: 0 16px;
    }

    .product-card {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid var(--neon-secondary);
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.3);
      cursor: pointer;
    }

    .product-card:hover {
      border-color: var(--neon-accent);
      box-shadow: 0 0 25px rgba(255, 255, 0, 0.5);
      transform: translateY(-4px);
    }

    .product-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      border: 1px solid var(--neon-accent);
    }

    .product-name {
      font-weight: 600;
      color: white;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .product-price {
      color: var(--neon-accent);
      font-weight: 700;
      font-size: 1.1rem;
      text-shadow: 0 0 10px var(--neon-accent);
    }

    /* Sepet */
    .cart-section {
      background: rgba(0, 0, 0, 0.8);
      border: 1px solid var(--neon-primary);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .cart-total {
      font-weight: 700;
      color: var(--neon-accent);
      text-shadow: 0 0 10px var(--neon-accent);
      font-size: 1.2rem;
      margin-top: 16px;
      text-align: center;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .call-waiter-btn,
    .koz-iste-btn {
      background: linear-gradient(135deg, var(--neon-primary), var(--neon-secondary));
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      padding: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      font-size: 1rem;
    }

    .call-waiter-btn:hover,
    .koz-iste-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.8);
    }

    .koz-iste-btn {
      background: linear-gradient(135deg, var(--neon-secondary), var(--neon-accent));
      box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
    }

    .koz-iste-btn:hover {
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
    }

    /* Loading */
    .loading-overlay {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid var(--neon-primary);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .loading-spinner {
      border: 3px solid rgba(0, 255, 255, 0.3);
      border-top: 3px solid var(--neon-primary);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    /* Toast */
    .toast {
      background: rgba(0, 0, 0, 0.9);
      border: 1px solid var(--neon-primary);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .menu-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
      }
      
      .product-card {
        padding: 12px;
      }
      
      .product-icon {
        width: 40px;
        height: 40px;
      }
    }

    /* Partikül Pozisyonları */
    .particle:nth-child(1) { left: 10%; top: 20%; animation-delay: 0s; }
    .particle:nth-child(2) { left: 20%; top: 60%; animation-delay: 1s; }
    .particle:nth-child(3) { left: 30%; top: 40%; animation-delay: 2s; }
    .particle:nth-child(4) { left: 40%; top: 80%; animation-delay: 3s; }
    .particle:nth-child(5) { left: 50%; top: 30%; animation-delay: 4s; }
    .particle:nth-child(6) { left: 60%; top: 70%; animation-delay: 5s; }
    .particle:nth-child(7) { left: 70%; top: 50%; animation-delay: 6s; }
    .particle:nth-child(8) { left: 80%; top: 90%; animation-delay: 7s; }
    .particle:nth-child(9) { left: 90%; top: 25%; animation-delay: 8s; }
    .particle:nth-child(10) { left: 15%; top: 85%; animation-delay: 9s; }
    .particle:nth-child(11) { left: 25%; top: 15%; animation-delay: 10s; }
    .particle:nth-child(12) { left: 35%; top: 75%; animation-delay: 11s; }
    .particle:nth-child(13) { left: 45%; top: 35%; animation-delay: 12s; }
    .particle:nth-child(14) { left: 55%; top: 85%; animation-delay: 13s; }
    .particle:nth-child(15) { left: 65%; top: 45%; animation-delay: 14s; }
    .particle:nth-child(16) { left: 75%; top: 95%; animation-delay: 15s; }
    .particle:nth-child(17) { left: 85%; top: 55%; animation-delay: 16s; }
    .particle:nth-child(18) { left: 95%; top: 25%; animation-delay: 17s; }
    .particle:nth-child(19) { left: 5%; top: 65%; animation-delay: 18s; }
    .particle:nth-child(20) { left: 95%; top: 75%; animation-delay: 19s; }

    /* Ek stiller */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 1.2rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 255, 255, 0.3);
      border-top: 3px solid var(--neon-primary);
      border-radius: 50%;
      margin-bottom: 16px;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    .submit-order-btn {
      margin-bottom: 12px;
    }

    .koz-iste-btn {
      background: linear-gradient(135deg, var(--neon-secondary), var(--neon-accent));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 16px;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 0 20px rgba(255, 0, 255, 0.5);
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }
    
    .koz-iste-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.8);
    }

    /* Kullanım limiti butonları */
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .usage-limit-info {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Neon Arkaplan -->
  <div class="neon-background">
    <div class="neon-bg-gradient"></div>
    <div class="neon-grid"></div>
    <div class="neon-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="neon-border"></div>
  </div>

  <div class="main-container">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <p>Menü yükleniyor...</p>
    </div>


    <header class="glass-header">
      <div class="logo neon-text" id="restaurantName">Yükleniyor...</div>
      <div class="table-number">Masa <span id="table-id">--</span></div>
    </header>
    
    <main class="main-grid">
      <section class="menu-section">
        <div id="categoryBar" class="category-bar glass">
          <!-- Kategoriler buraya dinamik olarak gelecek -->
        </div>
        <div class="menu-grid" id="menuGrid">
          <!-- Menü kartları buraya dinamik olarak gelecek -->
        </div>
      </section>
      
      <aside class="order-section glass">
        <h2 class="neon-text">Sepetim</h2>
        <div id="cartItems">
          <!-- Sepet öğeleri buraya gelecek -->
        </div>
        <div class="cart-total" id="cartTotal">Toplam: 0₺</div>
        <button id="submitOrderBtn" class="neon-btn">Sipariş Ver</button>
      </aside>
    </main>
    
    <div class="action-buttons">
      <button id="callWaiterBtn" class="call-waiter-btn neon-btn">🔔 GARSON ÇAĞIR</button>
      <button id="kozIsteBtn" class="koz-iste-btn neon-btn">🔥 KÖZ İSTE</button>
    </div>
  <div id="toast-container"></div>
  
  <script src="icons.js?v=20250120"></script>
  <script type="module">
    // Güvenli API Konfigürasyonu - Konsol erişimi engellendi
    (function() {
      'use strict';
      
      // Şifrelenmiş veriler (Base64)
      const _0x4a2b = {
        _0x7c1d: 'aHR0cHM6Ly9lZ2NrbHpmaXl4eG52eXh3b293cS5zdXBhYmFzZS5jbw==',
        _0x8e3f: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnY2tsemZpeXh4bnZ5eHdvb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjQxMTcsImV4cCI6MjA2NDA0MDExN30.dfRQv3lYFCaI1T5ydOw4HyoEJ0I1wOSIUcG8ueEbxKQ'
      };
      
      // Şifre çözme fonksiyonu
      function _0x2d8e(_0x5f1a) {
        return atob(_0x5f1a);
      }
      
      // Global erişimi engelle
      Object.defineProperty(window, 'SUPABASE_CONFIG', {
        get: function() {
          return {
            url: _0x2d8e(_0x4a2b._0x7c1d),
            anonKey: _0x4a2b._0x8e3f
          };
        },
        set: function() {
          console.warn('⚠️ API konfigürasyonu korunuyor');
          return false;
        },
        configurable: false,
        enumerable: false
      });
      
      // Konsol erişimini engelle
      const _0x3f7e = console.log;
      const _0x1a2b = console.warn;
      const _0x5c4d = console.error;
      
      console.log = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x3f7e.apply(console, args);
      };
      
      console.warn = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x1a2b.apply(console, args);
      };
      
      console.error = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x5c4d.apply(console, args);
      };
      
      // Object.keys ve Object.values erişimini engelle
      const _0x8f2c = Object.keys;
      const _0x7d4e = Object.values;
      
      Object.keys = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x8f2c.call(this, obj);
      };
      
      Object.values = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x7d4e.call(this, obj);
      };
      
      // JSON.stringify erişimini engelle
      const _0x4e2a = JSON.stringify;
      JSON.stringify = function(obj) {
        if (obj && (obj.url || obj.anonKey)) {
          return '{"protected": true}';
        }
        return _0x4e2a.call(this, obj);
      };
      
      // DevTools erişimini engelle
      setInterval(function() {
        if (window.outerHeight - window.innerHeight > 200) {
          window.SUPABASE_CONFIG = {
            url: '[PROTECTED]',
            anonKey: '[PROTECTED]'
          };
        }
      }, 1000);
      
    })();

    // Doğrudan import
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    import { productIcons } from './icons.js';

    // URL parametrelerinden restoran ve masa bilgilerini al
    const urlParams = new URLSearchParams(window.location.search);
    const RESTAURANT_ID = urlParams.get('restaurant_id');
    const TABLE_ID = urlParams.get('table_id');

    // Debug bilgileri (API bilgileri gizli)
    console.log('🔍 Uygulama başlatılıyor...');
    console.log('Restaurant ID:', RESTAURANT_ID);
    console.log('Table ID:', TABLE_ID);
    
    // API güvenlik kontrolü
    if (typeof window.SUPABASE_CONFIG === 'undefined') {
      console.error('❌ API konfigürasyonu bulunamadı');
      return;
    }

    // Supabase client oluştur (güvenli config)
    const supabase = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

    // Global değişkenler
    let restaurantInfo = null;
    let tableInfo = null;
    let products = [];
    let categories = [];
    let orders = [];
    let currentOrder = null;
    let currentSessionId = null;
    let usageLimits = {
      order: { count: 0, limit: 5, remaining: 5 },
      call_waiter: { count: 0, limit: 5, remaining: 5 },
      call_charcoal: { count: 0, limit: 5, remaining: 5 }
    };

    // Kullanıcı bilgileri ve oturumu oluştur/al
    async function initializeUserSession() {
      try {
        // Her QR okutma işleminde yeni session ID oluştur
        currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        console.log('🆕 Yeni kullanıcı session\'ı oluşturuluyor:', currentSessionId);
        console.log('📱 Bu kullanıcı için 5 sipariş, 5 garson çağırma, 5 köz isteme hakkı var');

        // Kullanıcı bilgilerini topla
        const userInfo = {
          sessionId: currentSessionId,
          userAgent: navigator.userAgent,
          language: navigator.language,
          platform: navigator.platform,
          screenResolution: `${screen.width}x${screen.height}`,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          timestamp: new Date().toISOString(),
          restaurantId: RESTAURANT_ID,
          tableId: TABLE_ID,
          // IP adresi için alternatif yöntemler
          referrer: document.referrer,
          url: window.location.href
        };

        console.log('🔐 Kullanıcı oturumu başlatılıyor:', currentSessionId);
        console.log('👤 Kullanıcı bilgileri:', userInfo);

        // Oturumu oluştur veya mevcut oturumu al
        const { data: sessionData, error: sessionError } = await supabase
          .rpc('get_or_create_user_session', {
            p_session_id: currentSessionId,
            p_restaurant_id: RESTAURANT_ID,
            p_table_id: TABLE_ID,
            p_user_agent: navigator.userAgent,
            p_ip_address: null // IP adresi client-side'da alınamaz
          });

        if (sessionError) {
          console.error('❌ Oturum oluşturulamadı:', sessionError);
          return false;
        }

        console.log('✅ Kullanıcı oturumu oluşturuldu:', sessionData);
        
        // Kullanım limitlerini yükle
        await loadUsageLimits();
        
        return true;
      } catch (error) {
        console.error('❌ Oturum başlatma hatası:', error);
        return false;
      }
    }

    // Kullanım limitlerini yükle
    async function loadUsageLimits() {
      try {
        const actions = ['order', 'call_waiter', 'call_charcoal'];
        
        for (const action of actions) {
          const { data, error } = await supabase
            .rpc('get_usage_info', {
              p_session_id: currentSessionId,
              p_action_type: action
            });

          if (!error && data && data.length > 0) {
            const info = data[0];
            usageLimits[action] = {
              count: info.action_count,
              limit: info.daily_limit,
              remaining: info.remaining_count
            };
          }
        }

        console.log('📊 Kullanım limitleri yüklendi:', usageLimits);
        updateUsageDisplay();
      } catch (error) {
        console.error('❌ Kullanım limitleri yüklenemedi:', error);
      }
    }

    // Detaylı kullanıcı bilgilerini al
    function getUserInfo() {
      return {
        sessionId: currentSessionId,
        userAgent: navigator.userAgent,
        language: navigator.language,
        platform: navigator.platform,
        screenResolution: `${screen.width}x${screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        timestamp: new Date().toISOString(),
        restaurantId: RESTAURANT_ID,
        tableId: TABLE_ID,
        referrer: document.referrer,
        url: window.location.href,
        // Ek bilgiler
        cookieEnabled: navigator.cookieEnabled,
        doNotTrack: navigator.doNotTrack,
        hardwareConcurrency: navigator.hardwareConcurrency,
        maxTouchPoints: navigator.maxTouchPoints,
        onLine: navigator.onLine,
        // Coğrafi konum (kullanıcı izni gerekir)
        geolocation: 'available' in navigator,
        // Cihaz bilgileri
        deviceMemory: navigator.deviceMemory,
        connection: navigator.connection ? {
          effectiveType: navigator.connection.effectiveType,
          downlink: navigator.connection.downlink,
          rtt: navigator.connection.rtt
        } : null
      };
    }

    // Kullanıcı bilgilerini konsola yazdır
    function logUserInfo() {
      const userInfo = getUserInfo();
      console.log('👤 Kullanıcı Bilgileri:', userInfo);
      console.log('🆔 Session ID:', userInfo.sessionId);
      console.log('🌐 Tarayıcı:', userInfo.userAgent);
      console.log('📱 Platform:', userInfo.platform);
      console.log('🖥️ Ekran:', userInfo.screenResolution);
      console.log('⏰ Zaman Dilimi:', userInfo.timezone);
      console.log('🍽️ Restoran ID:', userInfo.restaurantId);
      console.log('🪑 Masa ID:', userInfo.tableId);
      console.log('⏰ Session Süresi: 24 saat (1 gün sonra otomatik silinir)');
      console.log('🔄 Kullanım Limitleri: Her kullanıcı için günlük 5 sipariş, 5 garson çağırma, 5 köz isteme');
      console.log('🗑️ Otomatik Temizleme: Her saat başı eski session\'lar silinir');
      console.log('🆕 Yeni Kullanıcı: Her QR okutma işleminde yeni session oluşturulur');
      console.log('👥 Çoklu Kullanıcı: Aynı masada farklı kullanıcılar kendi limitlerini kullanır');
    }

    // Kullanım limiti kontrolü
    async function checkUsageLimit(actionType) {
      try {
        const { data, error } = await supabase
          .rpc('check_usage_limit', {
            p_session_id: currentSessionId,
            p_action_type: actionType
          });

        if (error) {
          console.error('❌ Limit kontrolü hatası:', error);
          return false;
        }

        // Limit bilgilerini güncelle
        await loadUsageLimits();

        // Kullanıcıya bilgi ver
        if (data && data.length > 0) {
          const result = data[0];
          if (!result.can_proceed) {
            showToast(`❌ Günlük ${getActionName(actionType)} limitiniz doldu! Yeni QR okutarak tekrar deneyebilirsiniz.`, 'error');
          } else {
            showToast(`✅ ${getActionName(actionType)} başarılı! Kalan hak: ${result.remaining_count}`, 'success');
          }
        }

        return data;
      } catch (error) {
        console.error('❌ Limit kontrolü hatası:', error);
        return false;
      }
    }

    // İşlem adını getir
    function getActionName(actionType) {
      switch(actionType) {
        case 'order': return 'Sipariş';
        case 'call_waiter': return 'Garson Çağırma';
        case 'call_charcoal': return 'Köz İsteme';
        default: return 'İşlem';
      }
    }

    // Kullanım limiti gösterimi güncelle
    function updateUsageDisplay() {
      const orderBtn = document.getElementById('submitOrderBtn');
      const waiterBtn = document.getElementById('callWaiterBtn');
      const charcoalBtn = document.getElementById('kozIsteBtn');

      if (orderBtn) {
        const remaining = usageLimits.order.remaining;
        orderBtn.innerHTML = `Sipariş Ver (${remaining}/5)`;
        orderBtn.disabled = remaining <= 0;
        if (remaining <= 0) {
          orderBtn.title = 'Günlük sipariş limitiniz doldu. Yeni QR okutarak tekrar deneyebilirsiniz.';
        }
      }

      if (waiterBtn) {
        const remaining = usageLimits.call_waiter.remaining;
        waiterBtn.innerHTML = `🔔 GARSON ÇAĞIR (${remaining}/5)`;
        waiterBtn.disabled = remaining <= 0;
        if (remaining <= 0) {
          waiterBtn.title = 'Günlük garson çağırma limitiniz doldu. Yeni QR okutarak tekrar deneyebilirsiniz.';
        }
      }

      if (charcoalBtn) {
        const remaining = usageLimits.call_charcoal.remaining;
        charcoalBtn.innerHTML = `🔥 KÖZ İSTE (${remaining}/5)`;
        charcoalBtn.disabled = remaining <= 0;
        if (remaining <= 0) {
          charcoalBtn.title = 'Günlük köz isteme limitiniz doldu. Yeni QR okutarak tekrar deneyebilirsiniz.';
        }
      }
    }

    // DOM elementleri
    const menuGrid = document.getElementById('menuGrid');
    const categoryBar = document.getElementById('categoryBar');
    const orderList = document.getElementById('order-list');
    const toastContainer = document.getElementById('toast-container');
    const tableIdElement = document.getElementById('table-id');
    const restaurantNameElement = document.getElementById('restaurantName');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const callWaiterBtn = document.getElementById('callWaiterBtn');
    const kozIsteBtn = document.getElementById('kozIsteBtn');

    // Sayfa yüklendiğinde başlat
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('🚀 Uygulama başlatılıyor...');
        await initializeApp();
      } catch (error) {
        console.error('❌ Uygulama başlatılamadı:', error);
        showToast('Uygulama yüklenirken hata oluştu', 'error');
      } finally {
        // Yükleme ekranını kaldır
        loadingOverlay.style.display = 'none';
      }
    });

    // Uygulamayı başlat
    async function initializeApp() {
      try {
        console.log('🚀 Uygulama başlatılıyor...');
        
        // Kullanıcı oturumunu başlat
        const sessionInitialized = await initializeUserSession();
        if (!sessionInitialized) {
          showToast('Oturum başlatılamadı!', 'error');
          return;
        }

        // Kullanıcı bilgilerini yazdır
        logUserInfo();
        
        // Session bilgisi toast mesajı
        showToast('✅ Yeni kullanıcı oturumu başlatıldı! 5 sipariş, 5 garson çağırma, 5 köz isteme hakkınız var.', 'success');
        
        // Restoran ve masa bilgilerini al
        restaurantInfo = await getRestaurantInfo();
        tableInfo = await getTableInfo();
        
        console.log('📋 Restoran Bilgileri:', restaurantInfo);
        console.log('🪑 Masa Bilgileri:', tableInfo);
        
        if (!restaurantInfo || !tableInfo) {
          showToast('Restoran veya masa bilgileri bulunamadı', 'error');
          return;
        }

        // Ürünler ve kategorileri al
        products = await getProducts();
        categories = await getProductCategories();
        
        console.log('🍽️ Ürünler:', products);
        console.log('📂 Kategoriler:', categories);

        // UI'yi güncelle
        updateUI();
        
        // Kategori barını oluştur
        createCategoryBar();
        
        // Menüyü render et
        renderMenu();
        
        // Siparişleri render et
        renderOrders();
        
        // Event listener'ları ekle
        submitOrderBtn.addEventListener('click', submitOrder);
        callWaiterBtn.addEventListener('click', () => callWaiter('waiter'));
        kozIsteBtn.addEventListener('click', () => callWaiter('charcoal'));
        
        console.log('✅ Uygulama başarıyla başlatıldı!');
        
      } catch (error) {
        console.error('❌ Uygulama başlatma hatası:', error);
        showToast('Uygulama başlatılırken hata oluştu', 'error');
      }
    }

    // Restoran bilgilerini getir
    async function getRestaurantInfo() {
      console.log('🔍 getRestaurantInfo çağrıldı, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('restaurants')
          .select('*')
          .eq('id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('✅ Restoran bilgileri alındı:', data);
        return data;
      } catch (error) {
        console.error('❌ Restoran bilgileri alınamadı:', error);
        return null;
      }
    }

    // Masa bilgilerini getir
    async function getTableInfo() {
      console.log('🔍 getTableInfo çağrıldı, Table ID:', TABLE_ID);
      try {
        const { data, error } = await supabase
          .from('tables')
          .select('*')
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('✅ Masa bilgileri alındı:', data);
        return data;
      } catch (error) {
        console.error('❌ Masa bilgileri alınamadı:', error);
        return null;
      }
    }

    // Restoranın ürünlerini getir
    async function getProducts() {
      console.log('🔍 getProducts çağrıldı, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .eq('is_active', true)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('✅ Ürünler alındı:', data);
        return data || [];
      } catch (error) {
        console.error('❌ Ürünler alınamadı:', error);
        return [];
      }
    }

    // Ürün kategorilerini getir
    async function getProductCategories() {
      console.log('🔍 getProductCategories çağrıldı, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('product_categories')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('✅ Ürün kategorileri alındı:', data);
        return data || [];
      } catch (error) {
        console.error('❌ Ürün kategorileri alınamadı:', error);
        return [];
      }
    }

    // UI'yi güncelle
    function updateUI() {
      // Logo ve restoran adı
      if (restaurantInfo) {
        restaurantNameElement.textContent = restaurantInfo.name || 'QR Menü';
      }
      
      // Masa numarası
      if (tableInfo) {
        tableIdElement.textContent = tableInfo.number || '--';
      }
    }

    // Kategori barını oluştur
    function createCategoryBar() {
      // Tümü kategorisi
      const allCategoriesBtn = `
        <button class="category-btn active" data-key="all">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">Tümü</span>
        </button>
      `;
      
      // Kategorileri oluştur
      const categoryButtons = categories.map(cat => `
        <button class="category-btn" data-key="${cat.id}">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">${cat.name}</span>
        </button>
      `).join('');
      
      categoryBar.innerHTML = allCategoriesBtn + categoryButtons;
      
      // Kategori tıklama olayları
      categoryBar.addEventListener('click', e => {
        const btn = e.target.closest('.category-btn');
        if (!btn) return;
        
        const categoryId = btn.dataset.key;
        filterByCategory(categoryId);
        updateCategoryBar(categoryId);
      });
    }

    // Kategori barını güncelle
    function updateCategoryBar(activeCategoryId = 'all') {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.key === activeCategoryId);
      });
    }

    // Kategoriye göre filtrele
    function filterByCategory(categoryId) {
      let filteredProducts = products;
      
      if (categoryId !== 'all') {
        filteredProducts = products.filter(product => product.category_id === categoryId || product.category === categoryId);
      }
      
      renderMenu(filteredProducts);
    }

    // Ürün adına göre fotoğraf döndüren fonksiyon
    function getProductIcon(name) {
      if (!name) return productIcons.default;
      const key = name.toLowerCase()
        .replace(/ı/g, 'i')
        .replace(/ü/g, 'u')
        .replace(/ö/g, 'o')
        .replace(/ş/g, 's')
        .replace(/ç/g, 'c')
        .replace(/ğ/g, 'g');
      return productIcons[key] || productIcons.default;
    }

    // Menü kartlarını oluştur
    function renderMenu(productsToRender = products) {
      menuGrid.innerHTML = '';
      
      if (productsToRender.length === 0) {
        menuGrid.innerHTML = '<div class="no-products">Bu kategoride ürün bulunamadı.</div>';
        return;
      }
      
      productsToRender.forEach(product => {
        const card = document.createElement('div');
        card.className = 'menu-card glass';
        card.innerHTML = `
          <div class="menu-icon-svg">${getProductIcon(product.name)}</div>
          <div class="menu-info">
            <h3>${product.name}</h3>
            <p>${product.description || ''}</p>
            <div class="menu-bottom">
              <span class="menu-price">${product.price}${restaurantInfo?.currency || '₺'}</span>
              <button class="neon-btn" data-id="${product.id}" data-price="${product.price}">
                Sipariş Ver
              </button>
            </div>
          </div>
        `;
        menuGrid.appendChild(card);
      });
      
      // Sipariş butonlarına tıklama olayları
      menuGrid.querySelectorAll('.neon-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const productId = btn.dataset.id;
          const product = products.find(p => p.id === productId);
          if (product) {
            addToOrder(product);
          }
        });
      });
    }

    // Sipariş listesi
    function renderOrders() {
      orderList.innerHTML = '';
      
      if (orders.length === 0) {
        orderList.innerHTML = '<li>Henüz sipariş yok.</li>';
        return;
      }
      
      // Ürünleri grupla ve miktarları hesapla
      const groupedOrders = {};
      orders.forEach(item => {
        if (groupedOrders[item.id]) {
          groupedOrders[item.id].quantity += 1;
        } else {
          groupedOrders[item.id] = { ...item, quantity: 1 };
        }
      });
      
      // Toplam fiyatı hesapla
      let totalPrice = 0;
      
      Object.values(groupedOrders).forEach(item => {
        const li = document.createElement('li');
        const itemTotal = parseFloat(item.price) * item.quantity;
        totalPrice += itemTotal;
        
        li.innerHTML = `
          <div class="order-item">
            <span class="item-name">${item.name}</span>
            <span class="item-quantity">x${item.quantity}</span>
            <span class="item-price">${itemTotal}${restaurantInfo?.currency || '₺'}</span>
          </div>
        `;
        orderList.appendChild(li);
      });
      
      // Toplam fiyatı göster
      if (totalPrice > 0) {
        const totalLi = document.createElement('li');
        totalLi.className = 'order-total';
        totalLi.innerHTML = `
          <div class="total-line">
            <span>Toplam:</span>
            <span class="total-price">${totalPrice}${restaurantInfo?.currency || '₺'}</span>
          </div>
        `;
        orderList.appendChild(totalLi);
      }
    }

    // Siparişe ürün ekle
    function addToOrder(product) {
      orders.push(product);
      renderOrders();
      showToast(`${product.name} siparişe eklendi!`, 'success');
    }

    // Siparişi gönder
    async function submitOrder() {
      if (orders.length === 0) {
        showToast('Sipariş listesi boş!', 'error');
        return;
      }

      // Kullanım limiti kontrolü
      const canOrder = await checkUsageLimit('order');
      if (!canOrder) {
        showToast('Günlük sipariş limitiniz doldu! Yarın tekrar deneyebilirsiniz.', 'error');
        return;
      }
      
      try {
        // Toplam fiyatı hesapla
        const totalPrice = orders.reduce((sum, item) => sum + parseFloat(item.price), 0);
        
        // Sipariş oluştur
        const { data, error } = await supabase
          .from('orders')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            status: 'pending',
            total_price: totalPrice,
            note: 'QR menüden sipariş'
          }])
          .select()
          .single();
        
        if (error) throw error;
        
        // Sipariş kalemlerini ekle
        const groupedOrders = {};
        orders.forEach(item => {
          if (groupedOrders[item.id]) {
            groupedOrders[item.id].quantity += 1;
          } else {
            groupedOrders[item.id] = { ...item, quantity: 1 };
          }
        });
        
        for (const [productId, item] of Object.entries(groupedOrders)) {
          await supabase
            .from('order_items')
            .insert([{
              order_id: data.id,
              product_id: productId,
              quantity: item.quantity,
              unit_price: parseFloat(item.price),
              note: null
            }]);
        }
        
        // Masa durumunu güncelle
        await supabase
          .from('tables')
          .update({ status: 'active' })
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID);
        
        // Sipariş listesini temizle
        orders = [];
        renderOrders();
        
        showToast('Siparişiniz başarıyla gönderildi!', 'success');
        
      } catch (error) {
        console.error('❌ Sipariş gönderilemedi:', error);
        showToast('Sipariş gönderilirken hata oluştu', 'error');
      }
    }

    // Garson çağır
    async function callWaiter(callType = 'waiter') {
      // Kullanım limiti kontrolü
      const actionType = callType === 'waiter' ? 'call_waiter' : 'call_charcoal';
      const canCall = await checkUsageLimit(actionType);
      
      if (!canCall) {
        const message = callType === 'waiter' 
          ? 'Günlük garson çağırma limitiniz doldu! Yarın tekrar deneyebilirsiniz.'
          : 'Günlük köz isteme limitiniz doldu! Yarın tekrar deneyebilirsiniz.';
        showToast(message, 'error');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('calls')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            type: callType === 'waiter' ? 'garson' : 'köz',
            status: 'pending'
          }])
          .select()
          .single();

        if (error) throw error;
        
        if (callType === 'waiter') {
          showToast('Garson çağrıldı! Lütfen bekleyiniz.', 'info');
        } else if (callType === 'charcoal') {
          showToast('Köz isteğiniz iletildi! Lütfen bekleyiniz.', 'info');
        }
        
        return data;
      } catch (error) {
        console.error('❌ Çağrı oluşturulamadı:', error);
        showToast('Çağrı oluşturulamadı', 'error');
        throw error;
      }
    }

    // Toast bildirim fonksiyonu
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 600);
      }, 2500);
    }
  </script>
</body>
</html> 