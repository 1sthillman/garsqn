<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>TR QR Men√º</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=20250120" />
  <style>
    /* Ek stiller */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 1.2rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top: 3px solid var(--color-primary);
      border-radius: 50%;
      margin-bottom: 16px;
    }

    .submit-order-btn {
      margin-bottom: 12px;
    }

    .koz-iste-btn {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      color: #333;
      border: none;
      border-radius: 32px;
      padding: 16px 0;
      font-size: 1.1rem;
      font-family: 'Space Grotesk', Arial, sans-serif;
      font-weight: 700;
      box-shadow: 0 4px 24px 0 rgba(255,154,158,0.3);
      cursor: pointer;
      transition: transform 0.18s cubic-bezier(0.4,0,0.2,1), box-shadow 0.18s;
      margin-top: 12px;
      outline: none;
      position: relative;
      overflow: hidden;
      width: 100%;
    }
    
    .koz-iste-btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 8px 0 rgba(255,154,158,0.18);
    }

    /* Kullanƒ±m limiti butonlarƒ± */
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .usage-limit-info {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Neon Arkaplan -->
  <div class="neon-background">
    <div class="neon-bg-gradient"></div>
    <div class="neon-grid"></div>
    <div class="neon-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="neon-border"></div>
  </div>

  <div class="main-container">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <p>Men√º y√ºkleniyor...</p>
    </div>


    <header class="glass-header">
      <div class="logo neon-text" id="restaurantName">Y√ºkleniyor...</div>
      <div class="table-number">Masa <span id="table-id">--</span></div>
    </header>
    
    <main class="main-grid">
      <section class="menu-section">
        <div id="categoryBar" class="category-bar glass">
          <!-- Kategoriler buraya dinamik olarak gelecek -->
        </div>
        <div class="menu-grid" id="menuGrid">
          <!-- Men√º kartlarƒ± buraya dinamik olarak gelecek -->
        </div>
      </section>
      
      <aside class="order-section glass">
        <h2 class="neon-text">Sepetim</h2>
        <div id="cartItems">
          <!-- Sepet √∂ƒüeleri buraya gelecek -->
        </div>
        <div class="cart-total" id="cartTotal">Toplam: 0‚Ç∫</div>
        <button id="submitOrderBtn" class="neon-btn">Sipari≈ü Ver</button>
      </aside>
    </main>
    
    <div class="action-buttons">
      <button id="callWaiterBtn" class="call-waiter-btn neon-btn">üîî GARSON √áAƒûIR</button>
      <button id="kozIsteBtn" class="koz-iste-btn neon-btn">üî• K√ñZ ƒ∞STE</button>
    </div>
  <div id="toast-container"></div>
  
  <script src="icons.js?v=20250120"></script>
  <script type="module">
    // G√ºvenli API Konfig√ºrasyonu - Konsol eri≈üimi engellendi
    (function() {
      'use strict';
      
      // ≈ûifrelenmi≈ü veriler (Base64)
      const _0x4a2b = {
        _0x7c1d: 'aHR0cHM6Ly9lZ2NrbHpmaXl4eG52eXh3b293cS5zdXBhYmFzZS5jbw==',
        _0x8e3f: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnY2tsemZpeXh4bnZ5eHdvb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjQxMTcsImV4cCI6MjA2NDA0MDExN30.dfRQv3lYFCaI1T5ydOw4HyoEJ0I1wOSIUcG8ueEbxKQ'
      };
      
      // ≈ûifre √ß√∂zme fonksiyonu
      function _0x2d8e(_0x5f1a) {
        return atob(_0x5f1a);
      }
      
      // Global eri≈üimi engelle
      Object.defineProperty(window, 'SUPABASE_CONFIG', {
        get: function() {
          return {
            url: _0x2d8e(_0x4a2b._0x7c1d),
            anonKey: _0x4a2b._0x8e3f
          };
        },
        set: function() {
          console.warn('‚ö†Ô∏è API konfig√ºrasyonu korunuyor');
          return false;
        },
        configurable: false,
        enumerable: false
      });
      
      // Konsol eri≈üimini engelle
      const _0x3f7e = console.log;
      const _0x1a2b = console.warn;
      const _0x5c4d = console.error;
      
      console.log = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x3f7e.apply(console, args);
      };
      
      console.warn = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x1a2b.apply(console, args);
      };
      
      console.error = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x5c4d.apply(console, args);
      };
      
      // Object.keys ve Object.values eri≈üimini engelle
      const _0x8f2c = Object.keys;
      const _0x7d4e = Object.values;
      
      Object.keys = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x8f2c.call(this, obj);
      };
      
      Object.values = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x7d4e.call(this, obj);
      };
      
      // JSON.stringify eri≈üimini engelle
      const _0x4e2a = JSON.stringify;
      JSON.stringify = function(obj) {
        if (obj && (obj.url || obj.anonKey)) {
          return '{"protected": true}';
        }
        return _0x4e2a.call(this, obj);
      };
      
      // DevTools eri≈üimini engelle
      setInterval(function() {
        if (window.outerHeight - window.innerHeight > 200) {
          window.SUPABASE_CONFIG = {
            url: '[PROTECTED]',
            anonKey: '[PROTECTED]'
          };
        }
      }, 1000);
      
    })();

    // Doƒürudan import
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    import { productIcons } from './icons.js';

    // URL parametrelerinden restoran ve masa bilgilerini al
    const urlParams = new URLSearchParams(window.location.search);
    const RESTAURANT_ID = urlParams.get('restaurant_id');
    const TABLE_ID = urlParams.get('table_id');

    // Debug bilgileri (API bilgileri gizli)
    console.log('üîç Uygulama ba≈ülatƒ±lƒ±yor...');
    console.log('Restaurant ID:', RESTAURANT_ID);
    console.log('Table ID:', TABLE_ID);
    
    // API g√ºvenlik kontrol√º
    if (typeof window.SUPABASE_CONFIG === 'undefined') {
      console.error('‚ùå API konfig√ºrasyonu bulunamadƒ±');
      return;
    }

    // Supabase client olu≈ütur (g√ºvenli config)
    const supabase = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

    // Global deƒüi≈ükenler
    let restaurantInfo = null;
    let tableInfo = null;
    let products = [];
    let categories = [];
    let orders = [];
    let currentOrder = null;
    let currentSessionId = null;
    let usageLimits = {
      order: { count: 0, limit: 5, remaining: 5 },
      call_waiter: { count: 0, limit: 5, remaining: 5 },
      call_charcoal: { count: 0, limit: 5, remaining: 5 }
    };

    // Kullanƒ±cƒ± oturumu olu≈ütur/al
    async function initializeUserSession() {
      try {
        // Benzersiz session ID olu≈ütur
        if (!currentSessionId) {
          currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        console.log('üîê Kullanƒ±cƒ± oturumu ba≈ülatƒ±lƒ±yor:', currentSessionId);

        // Oturumu olu≈ütur veya mevcut oturumu al
        const { data: sessionData, error: sessionError } = await supabase
          .rpc('get_or_create_user_session', {
            p_session_id: currentSessionId,
            p_restaurant_id: RESTAURANT_ID,
            p_table_id: TABLE_ID,
            p_user_agent: navigator.userAgent,
            p_ip_address: null // IP adresi client-side'da alƒ±namaz
          });

        if (sessionError) {
          console.error('‚ùå Oturum olu≈üturulamadƒ±:', sessionError);
          return false;
        }

        console.log('‚úÖ Kullanƒ±cƒ± oturumu olu≈üturuldu:', sessionData);
        
        // Kullanƒ±m limitlerini y√ºkle
        await loadUsageLimits();
        
        return true;
      } catch (error) {
        console.error('‚ùå Oturum ba≈ülatma hatasƒ±:', error);
        return false;
      }
    }

    // Kullanƒ±m limitlerini y√ºkle
    async function loadUsageLimits() {
      try {
        const actions = ['order', 'call_waiter', 'call_charcoal'];
        
        for (const action of actions) {
          const { data, error } = await supabase
            .rpc('get_usage_info', {
              p_session_id: currentSessionId,
              p_action_type: action
            });

          if (!error && data && data.length > 0) {
            const info = data[0];
            usageLimits[action] = {
              count: info.action_count,
              limit: info.daily_limit,
              remaining: info.remaining_count
            };
          }
        }

        console.log('üìä Kullanƒ±m limitleri y√ºklendi:', usageLimits);
        updateUsageDisplay();
      } catch (error) {
        console.error('‚ùå Kullanƒ±m limitleri y√ºklenemedi:', error);
      }
    }

    // Kullanƒ±m limiti kontrol√º
    async function checkUsageLimit(actionType) {
      try {
        const { data, error } = await supabase
          .rpc('check_usage_limit', {
            p_session_id: currentSessionId,
            p_action_type: actionType
          });

        if (error) {
          console.error('‚ùå Limit kontrol√º hatasƒ±:', error);
          return false;
        }

        // Limit bilgilerini g√ºncelle
        await loadUsageLimits();

        return data;
      } catch (error) {
        console.error('‚ùå Limit kontrol√º hatasƒ±:', error);
        return false;
      }
    }

    // Kullanƒ±m limiti g√∂sterimi g√ºncelle
    function updateUsageDisplay() {
      const orderBtn = document.getElementById('submitOrderBtn');
      const waiterBtn = document.getElementById('callWaiterBtn');
      const charcoalBtn = document.getElementById('kozIsteBtn');

      if (orderBtn) {
        orderBtn.innerHTML = `Sipari≈üi G√∂nder (${usageLimits.order.remaining} kaldƒ±)`;
        orderBtn.disabled = usageLimits.order.remaining <= 0;
      }

      if (waiterBtn) {
        waiterBtn.innerHTML = `Garson √áaƒüƒ±r (${usageLimits.call_waiter.remaining} kaldƒ±)`;
        waiterBtn.disabled = usageLimits.call_waiter.remaining <= 0;
      }

      if (charcoalBtn) {
        charcoalBtn.innerHTML = `K√∂z ƒ∞ste (${usageLimits.call_charcoal.remaining} kaldƒ±)`;
        charcoalBtn.disabled = usageLimits.call_charcoal.remaining <= 0;
      }
    }

    // DOM elementleri
    const menuGrid = document.getElementById('menuGrid');
    const categoryBar = document.getElementById('categoryBar');
    const orderList = document.getElementById('order-list');
    const toastContainer = document.getElementById('toast-container');
    const tableIdElement = document.getElementById('table-id');
    const restaurantNameElement = document.getElementById('restaurantName');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const callWaiterBtn = document.getElementById('callWaiterBtn');
    const kozIsteBtn = document.getElementById('kozIsteBtn');

    // Sayfa y√ºklendiƒüinde ba≈ülat
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('üöÄ Uygulama ba≈ülatƒ±lƒ±yor...');
        await initializeApp();
      } catch (error) {
        console.error('‚ùå Uygulama ba≈ülatƒ±lamadƒ±:', error);
        showToast('Uygulama y√ºklenirken hata olu≈ütu', 'error');
      } finally {
        // Y√ºkleme ekranƒ±nƒ± kaldƒ±r
        loadingOverlay.style.display = 'none';
      }
    });

    // Uygulamayƒ± ba≈ülat
    async function initializeApp() {
      try {
        console.log('üöÄ Uygulama ba≈ülatƒ±lƒ±yor...');
        
        // Kullanƒ±cƒ± oturumunu ba≈ülat
        const sessionInitialized = await initializeUserSession();
        if (!sessionInitialized) {
          showToast('Oturum ba≈ülatƒ±lamadƒ±!', 'error');
          return;
        }
        
        // Restoran ve masa bilgilerini al
        restaurantInfo = await getRestaurantInfo();
        tableInfo = await getTableInfo();
        
        console.log('üìã Restoran Bilgileri:', restaurantInfo);
        console.log('ü™ë Masa Bilgileri:', tableInfo);
        
        if (!restaurantInfo || !tableInfo) {
          showToast('Restoran veya masa bilgileri bulunamadƒ±', 'error');
          return;
        }

        // √úr√ºnler ve kategorileri al
        products = await getProducts();
        categories = await getProductCategories();
        
        console.log('üçΩÔ∏è √úr√ºnler:', products);
        console.log('üìÇ Kategoriler:', categories);

        // UI'yi g√ºncelle
        updateUI();
        
        // Kategori barƒ±nƒ± olu≈ütur
        createCategoryBar();
        
        // Men√ºy√º render et
        renderMenu();
        
        // Sipari≈üleri render et
        renderOrders();
        
        // Event listener'larƒ± ekle
        submitOrderBtn.addEventListener('click', submitOrder);
        callWaiterBtn.addEventListener('click', () => callWaiter('waiter'));
        kozIsteBtn.addEventListener('click', () => callWaiter('charcoal'));
        
        console.log('‚úÖ Uygulama ba≈üarƒ±yla ba≈ülatƒ±ldƒ±!');
        
      } catch (error) {
        console.error('‚ùå Uygulama ba≈ülatma hatasƒ±:', error);
        showToast('Uygulama ba≈ülatƒ±lƒ±rken hata olu≈ütu', 'error');
      }
    }

    // Restoran bilgilerini getir
    async function getRestaurantInfo() {
      console.log('üîç getRestaurantInfo √ßaƒürƒ±ldƒ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('restaurants')
          .select('*')
          .eq('id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('‚úÖ Restoran bilgileri alƒ±ndƒ±:', data);
        return data;
      } catch (error) {
        console.error('‚ùå Restoran bilgileri alƒ±namadƒ±:', error);
        return null;
      }
    }

    // Masa bilgilerini getir
    async function getTableInfo() {
      console.log('üîç getTableInfo √ßaƒürƒ±ldƒ±, Table ID:', TABLE_ID);
      try {
        const { data, error } = await supabase
          .from('tables')
          .select('*')
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('‚úÖ Masa bilgileri alƒ±ndƒ±:', data);
        return data;
      } catch (error) {
        console.error('‚ùå Masa bilgileri alƒ±namadƒ±:', error);
        return null;
      }
    }

    // Restoranƒ±n √ºr√ºnlerini getir
    async function getProducts() {
      console.log('üîç getProducts √ßaƒürƒ±ldƒ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .eq('is_active', true)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('‚úÖ √úr√ºnler alƒ±ndƒ±:', data);
        return data || [];
      } catch (error) {
        console.error('‚ùå √úr√ºnler alƒ±namadƒ±:', error);
        return [];
      }
    }

    // √úr√ºn kategorilerini getir
    async function getProductCategories() {
      console.log('üîç getProductCategories √ßaƒürƒ±ldƒ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('product_categories')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('‚úÖ √úr√ºn kategorileri alƒ±ndƒ±:', data);
        return data || [];
      } catch (error) {
        console.error('‚ùå √úr√ºn kategorileri alƒ±namadƒ±:', error);
        return [];
      }
    }

    // UI'yi g√ºncelle
    function updateUI() {
      // Logo ve restoran adƒ±
      if (restaurantInfo) {
        restaurantNameElement.textContent = restaurantInfo.name || 'QR Men√º';
      }
      
      // Masa numarasƒ±
      if (tableInfo) {
        tableIdElement.textContent = tableInfo.number || '--';
      }
    }

    // Kategori barƒ±nƒ± olu≈ütur
    function createCategoryBar() {
      // T√ºm√º kategorisi
      const allCategoriesBtn = `
        <button class="category-btn active" data-key="all">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">T√ºm√º</span>
        </button>
      `;
      
      // Kategorileri olu≈ütur
      const categoryButtons = categories.map(cat => `
        <button class="category-btn" data-key="${cat.id}">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">${cat.name}</span>
        </button>
      `).join('');
      
      categoryBar.innerHTML = allCategoriesBtn + categoryButtons;
      
      // Kategori tƒ±klama olaylarƒ±
      categoryBar.addEventListener('click', e => {
        const btn = e.target.closest('.category-btn');
        if (!btn) return;
        
        const categoryId = btn.dataset.key;
        filterByCategory(categoryId);
        updateCategoryBar(categoryId);
      });
    }

    // Kategori barƒ±nƒ± g√ºncelle
    function updateCategoryBar(activeCategoryId = 'all') {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.key === activeCategoryId);
      });
    }

    // Kategoriye g√∂re filtrele
    function filterByCategory(categoryId) {
      let filteredProducts = products;
      
      if (categoryId !== 'all') {
        filteredProducts = products.filter(product => product.category_id === categoryId || product.category === categoryId);
      }
      
      renderMenu(filteredProducts);
    }

    // √úr√ºn adƒ±na g√∂re fotoƒüraf d√∂nd√ºren fonksiyon
    function getProductIcon(name) {
      if (!name) return productIcons.default;
      const key = name.toLowerCase()
        .replace(/ƒ±/g, 'i')
        .replace(/√º/g, 'u')
        .replace(/√∂/g, 'o')
        .replace(/≈ü/g, 's')
        .replace(/√ß/g, 'c')
        .replace(/ƒü/g, 'g');
      return productIcons[key] || productIcons.default;
    }

    // Men√º kartlarƒ±nƒ± olu≈ütur
    function renderMenu(productsToRender = products) {
      menuGrid.innerHTML = '';
      
      if (productsToRender.length === 0) {
        menuGrid.innerHTML = '<div class="no-products">Bu kategoride √ºr√ºn bulunamadƒ±.</div>';
        return;
      }
      
      productsToRender.forEach(product => {
        const card = document.createElement('div');
        card.className = 'menu-card glass';
        card.innerHTML = `
          <div class="menu-icon-svg">${getProductIcon(product.name)}</div>
          <div class="menu-info">
            <h3>${product.name}</h3>
            <p>${product.description || ''}</p>
            <div class="menu-bottom">
              <span class="menu-price">${product.price}${restaurantInfo?.currency || '‚Ç∫'}</span>
              <button class="neon-btn" data-id="${product.id}" data-price="${product.price}">
                Sipari≈ü Ver
              </button>
            </div>
          </div>
        `;
        menuGrid.appendChild(card);
      });
      
      // Sipari≈ü butonlarƒ±na tƒ±klama olaylarƒ±
      menuGrid.querySelectorAll('.neon-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const productId = btn.dataset.id;
          const product = products.find(p => p.id === productId);
          if (product) {
            addToOrder(product);
          }
        });
      });
    }

    // Sipari≈ü listesi
    function renderOrders() {
      orderList.innerHTML = '';
      
      if (orders.length === 0) {
        orderList.innerHTML = '<li>Hen√ºz sipari≈ü yok.</li>';
        return;
      }
      
      // √úr√ºnleri grupla ve miktarlarƒ± hesapla
      const groupedOrders = {};
      orders.forEach(item => {
        if (groupedOrders[item.id]) {
          groupedOrders[item.id].quantity += 1;
        } else {
          groupedOrders[item.id] = { ...item, quantity: 1 };
        }
      });
      
      // Toplam fiyatƒ± hesapla
      let totalPrice = 0;
      
      Object.values(groupedOrders).forEach(item => {
        const li = document.createElement('li');
        const itemTotal = parseFloat(item.price) * item.quantity;
        totalPrice += itemTotal;
        
        li.innerHTML = `
          <div class="order-item">
            <span class="item-name">${item.name}</span>
            <span class="item-quantity">x${item.quantity}</span>
            <span class="item-price">${itemTotal}${restaurantInfo?.currency || '‚Ç∫'}</span>
          </div>
        `;
        orderList.appendChild(li);
      });
      
      // Toplam fiyatƒ± g√∂ster
      if (totalPrice > 0) {
        const totalLi = document.createElement('li');
        totalLi.className = 'order-total';
        totalLi.innerHTML = `
          <div class="total-line">
            <span>Toplam:</span>
            <span class="total-price">${totalPrice}${restaurantInfo?.currency || '‚Ç∫'}</span>
          </div>
        `;
        orderList.appendChild(totalLi);
      }
    }

    // Sipari≈üe √ºr√ºn ekle
    function addToOrder(product) {
      orders.push(product);
      renderOrders();
      showToast(`${product.name} sipari≈üe eklendi!`, 'success');
    }

    // Sipari≈üi g√∂nder
    async function submitOrder() {
      if (orders.length === 0) {
        showToast('Sipari≈ü listesi bo≈ü!', 'error');
        return;
      }

      // Kullanƒ±m limiti kontrol√º
      const canOrder = await checkUsageLimit('order');
      if (!canOrder) {
        showToast('G√ºnl√ºk sipari≈ü limitiniz doldu! Yarƒ±n tekrar deneyebilirsiniz.', 'error');
        return;
      }
      
      try {
        // Toplam fiyatƒ± hesapla
        const totalPrice = orders.reduce((sum, item) => sum + parseFloat(item.price), 0);
        
        // Sipari≈ü olu≈ütur
        const { data, error } = await supabase
          .from('orders')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            status: 'pending',
            total_price: totalPrice,
            note: 'QR men√ºden sipari≈ü'
          }])
          .select()
          .single();
        
        if (error) throw error;
        
        // Sipari≈ü kalemlerini ekle
        const groupedOrders = {};
        orders.forEach(item => {
          if (groupedOrders[item.id]) {
            groupedOrders[item.id].quantity += 1;
          } else {
            groupedOrders[item.id] = { ...item, quantity: 1 };
          }
        });
        
        for (const [productId, item] of Object.entries(groupedOrders)) {
          await supabase
            .from('order_items')
            .insert([{
              order_id: data.id,
              product_id: productId,
              quantity: item.quantity,
              unit_price: parseFloat(item.price),
              note: null
            }]);
        }
        
        // Masa durumunu g√ºncelle
        await supabase
          .from('tables')
          .update({ status: 'active' })
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID);
        
        // Sipari≈ü listesini temizle
        orders = [];
        renderOrders();
        
        showToast('Sipari≈üiniz ba≈üarƒ±yla g√∂nderildi!', 'success');
        
      } catch (error) {
        console.error('‚ùå Sipari≈ü g√∂nderilemedi:', error);
        showToast('Sipari≈ü g√∂nderilirken hata olu≈ütu', 'error');
      }
    }

    // Garson √ßaƒüƒ±r
    async function callWaiter(callType = 'waiter') {
      // Kullanƒ±m limiti kontrol√º
      const actionType = callType === 'waiter' ? 'call_waiter' : 'call_charcoal';
      const canCall = await checkUsageLimit(actionType);
      
      if (!canCall) {
        const message = callType === 'waiter' 
          ? 'G√ºnl√ºk garson √ßaƒüƒ±rma limitiniz doldu! Yarƒ±n tekrar deneyebilirsiniz.'
          : 'G√ºnl√ºk k√∂z isteme limitiniz doldu! Yarƒ±n tekrar deneyebilirsiniz.';
        showToast(message, 'error');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('calls')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            type: callType === 'waiter' ? 'garson' : 'k√∂z',
            status: 'pending'
          }])
          .select()
          .single();

        if (error) throw error;
        
        if (callType === 'waiter') {
          showToast('Garson √ßaƒürƒ±ldƒ±! L√ºtfen bekleyiniz.', 'info');
        } else if (callType === 'charcoal') {
          showToast('K√∂z isteƒüiniz iletildi! L√ºtfen bekleyiniz.', 'info');
        }
        
        return data;
      } catch (error) {
        console.error('‚ùå √áaƒürƒ± olu≈üturulamadƒ±:', error);
        showToast('√áaƒürƒ± olu≈üturulamadƒ±', 'error');
        throw error;
      }
    }

    // Toast bildirim fonksiyonu
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 600);
      }, 2500);
    }
  </script>
</body>
</html> 