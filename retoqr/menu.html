<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>TR QR MenÃ¼</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css?v=20250120" />
  <style>
    /* Ek stiller */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 1.2rem;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top: 3px solid var(--color-primary);
      border-radius: 50%;
      margin-bottom: 16px;
    }

    .submit-order-btn {
      margin-bottom: 12px;
    }

    .koz-iste-btn {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
      color: #333;
      border: none;
      border-radius: 32px;
      padding: 16px 0;
      font-size: 1.1rem;
      font-family: 'Space Grotesk', Arial, sans-serif;
      font-weight: 700;
      box-shadow: 0 4px 24px 0 rgba(255,154,158,0.3);
      cursor: pointer;
      transition: transform 0.18s cubic-bezier(0.4,0,0.2,1), box-shadow 0.18s;
      margin-top: 12px;
      outline: none;
      position: relative;
      overflow: hidden;
      width: 100%;
    }
    
    .koz-iste-btn:active {
      transform: scale(0.97);
      box-shadow: 0 2px 8px 0 rgba(255,154,158,0.18);
    }

    /* KullanÄ±m limiti butonlarÄ± */
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    .action-btn:disabled:hover {
      transform: none;
      box-shadow: none;
    }

    .usage-limit-info {
      font-size: 0.8rem;
      color: #6b7280;
      text-align: center;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <!-- Neon Arkaplan -->
  <div class="neon-background">
    <div class="neon-bg-gradient"></div>
    <div class="neon-grid"></div>
    <div class="neon-particles">
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
      <div class="particle"></div>
    </div>
    <div class="neon-border"></div>
  </div>

  <div class="main-container">
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
      <p>MenÃ¼ yÃ¼kleniyor...</p>
    </div>


    <header class="glass-header">
      <div class="logo neon-text" id="restaurantName">YÃ¼kleniyor...</div>
      <div class="table-number">Masa <span id="table-id">--</span></div>
    </header>
    
    <main class="main-grid">
      <section class="menu-section">
        <div id="categoryBar" class="category-bar glass">
          <!-- Kategoriler buraya dinamik olarak gelecek -->
        </div>
        <div class="menu-grid" id="menuGrid">
          <!-- MenÃ¼ kartlarÄ± buraya dinamik olarak gelecek -->
        </div>
      </section>
      
      <aside class="order-section glass">
        <h2 class="neon-text">Sepetim</h2>
        <div id="cartItems">
          <!-- Sepet Ã¶ÄŸeleri buraya gelecek -->
        </div>
        <div class="cart-total" id="cartTotal">Toplam: 0â‚º</div>
        <button id="submitOrderBtn" class="neon-btn">SipariÅŸ Ver</button>
      </aside>
    </main>
    
    <div class="action-buttons">
      <button id="callWaiterBtn" class="call-waiter-btn neon-btn">ğŸ”” GARSON Ã‡AÄIR</button>
      <button id="kozIsteBtn" class="koz-iste-btn neon-btn">ğŸ”¥ KÃ–Z Ä°STE</button>
    </div>
  <div id="toast-container"></div>
  
  <script src="icons.js?v=20250120"></script>
  <script type="module">
    // GÃ¼venli API KonfigÃ¼rasyonu - Konsol eriÅŸimi engellendi
    (function() {
      'use strict';
      
      // ÅifrelenmiÅŸ veriler (Base64)
      const _0x4a2b = {
        _0x7c1d: 'aHR0cHM6Ly9lZ2NrbHpmaXl4eG52eXh3b293cS5zdXBhYmFzZS5jbw==',
        _0x8e3f: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnY2tsemZpeXh4bnZ5eHdvb3dxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjQxMTcsImV4cCI6MjA2NDA0MDExN30.dfRQv3lYFCaI1T5ydOw4HyoEJ0I1wOSIUcG8ueEbxKQ'
      };
      
      // Åifre Ã§Ã¶zme fonksiyonu
      function _0x2d8e(_0x5f1a) {
        return atob(_0x5f1a);
      }
      
      // Global eriÅŸimi engelle
      Object.defineProperty(window, 'SUPABASE_CONFIG', {
        get: function() {
          return {
            url: _0x2d8e(_0x4a2b._0x7c1d),
            anonKey: _0x4a2b._0x8e3f
          };
        },
        set: function() {
          console.warn('âš ï¸ API konfigÃ¼rasyonu korunuyor');
          return false;
        },
        configurable: false,
        enumerable: false
      });
      
      // Konsol eriÅŸimini engelle
      const _0x3f7e = console.log;
      const _0x1a2b = console.warn;
      const _0x5c4d = console.error;
      
      console.log = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x3f7e.apply(console, args);
      };
      
      console.warn = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x1a2b.apply(console, args);
      };
      
      console.error = function(...args) {
        const _0x9e2f = args.join(' ').toLowerCase();
        if (_0x9e2f.includes('supabase') || _0x9e2f.includes('api') || _0x9e2f.includes('key') || _0x9e2f.includes('url')) {
          return;
        }
        _0x5c4d.apply(console, args);
      };
      
      // Object.keys ve Object.values eriÅŸimini engelle
      const _0x8f2c = Object.keys;
      const _0x7d4e = Object.values;
      
      Object.keys = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x8f2c.call(this, obj);
      };
      
      Object.values = function(obj) {
        if (obj === window.SUPABASE_CONFIG) {
          return [];
        }
        return _0x7d4e.call(this, obj);
      };
      
      // JSON.stringify eriÅŸimini engelle
      const _0x4e2a = JSON.stringify;
      JSON.stringify = function(obj) {
        if (obj && (obj.url || obj.anonKey)) {
          return '{"protected": true}';
        }
        return _0x4e2a.call(this, obj);
      };
      
      // DevTools eriÅŸimini engelle
      setInterval(function() {
        if (window.outerHeight - window.innerHeight > 200) {
          window.SUPABASE_CONFIG = {
            url: '[PROTECTED]',
            anonKey: '[PROTECTED]'
          };
        }
      }, 1000);
      
    })();

    // DoÄŸrudan import
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js';
    import { productIcons } from './icons.js';

    // URL parametrelerinden restoran ve masa bilgilerini al
    const urlParams = new URLSearchParams(window.location.search);
    const RESTAURANT_ID = urlParams.get('restaurant_id');
    const TABLE_ID = urlParams.get('table_id');

    // Debug bilgileri (API bilgileri gizli)
    console.log('ğŸ” Uygulama baÅŸlatÄ±lÄ±yor...');
    console.log('Restaurant ID:', RESTAURANT_ID);
    console.log('Table ID:', TABLE_ID);
    
    // API gÃ¼venlik kontrolÃ¼
    if (typeof window.SUPABASE_CONFIG === 'undefined') {
      console.error('âŒ API konfigÃ¼rasyonu bulunamadÄ±');
      return;
    }

    // Supabase client oluÅŸtur (gÃ¼venli config)
    const supabase = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.anonKey);

    // Global deÄŸiÅŸkenler
    let restaurantInfo = null;
    let tableInfo = null;
    let products = [];
    let categories = [];
    let orders = [];
    let currentOrder = null;
    let currentSessionId = null;
    let usageLimits = {
      order: { count: 0, limit: 5, remaining: 5 },
      call_waiter: { count: 0, limit: 5, remaining: 5 },
      call_charcoal: { count: 0, limit: 5, remaining: 5 }
    };

    // KullanÄ±cÄ± oturumu oluÅŸtur/al
    async function initializeUserSession() {
      try {
        // Benzersiz session ID oluÅŸtur
        if (!currentSessionId) {
          currentSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        console.log('ğŸ” KullanÄ±cÄ± oturumu baÅŸlatÄ±lÄ±yor:', currentSessionId);

        // Oturumu oluÅŸtur veya mevcut oturumu al
        const { data: sessionData, error: sessionError } = await supabase
          .rpc('get_or_create_user_session', {
            p_session_id: currentSessionId,
            p_restaurant_id: RESTAURANT_ID,
            p_table_id: TABLE_ID,
            p_user_agent: navigator.userAgent,
            p_ip_address: null // IP adresi client-side'da alÄ±namaz
          });

        if (sessionError) {
          console.error('âŒ Oturum oluÅŸturulamadÄ±:', sessionError);
          return false;
        }

        console.log('âœ… KullanÄ±cÄ± oturumu oluÅŸturuldu:', sessionData);
        
        // KullanÄ±m limitlerini yÃ¼kle
        await loadUsageLimits();
        
        return true;
      } catch (error) {
        console.error('âŒ Oturum baÅŸlatma hatasÄ±:', error);
        return false;
      }
    }

    // KullanÄ±m limitlerini yÃ¼kle
    async function loadUsageLimits() {
      try {
        const actions = ['order', 'call_waiter', 'call_charcoal'];
        
        for (const action of actions) {
          const { data, error } = await supabase
            .rpc('get_usage_info', {
              p_session_id: currentSessionId,
              p_action_type: action
            });

          if (!error && data && data.length > 0) {
            const info = data[0];
            usageLimits[action] = {
              count: info.action_count,
              limit: info.daily_limit,
              remaining: info.remaining_count
            };
          }
        }

        console.log('ğŸ“Š KullanÄ±m limitleri yÃ¼klendi:', usageLimits);
        updateUsageDisplay();
      } catch (error) {
        console.error('âŒ KullanÄ±m limitleri yÃ¼klenemedi:', error);
      }
    }

    // KullanÄ±m limiti kontrolÃ¼
    async function checkUsageLimit(actionType) {
      try {
        const { data, error } = await supabase
          .rpc('check_usage_limit', {
            p_session_id: currentSessionId,
            p_action_type: actionType
          });

        if (error) {
          console.error('âŒ Limit kontrolÃ¼ hatasÄ±:', error);
          return false;
        }

        // Limit bilgilerini gÃ¼ncelle
        await loadUsageLimits();

        return data;
      } catch (error) {
        console.error('âŒ Limit kontrolÃ¼ hatasÄ±:', error);
        return false;
      }
    }

    // KullanÄ±m limiti gÃ¶sterimi gÃ¼ncelle
    function updateUsageDisplay() {
      const orderBtn = document.getElementById('submitOrderBtn');
      const waiterBtn = document.getElementById('callWaiterBtn');
      const charcoalBtn = document.getElementById('kozIsteBtn');

      if (orderBtn) {
        orderBtn.innerHTML = `SipariÅŸi GÃ¶nder (${usageLimits.order.remaining} kaldÄ±)`;
        orderBtn.disabled = usageLimits.order.remaining <= 0;
      }

      if (waiterBtn) {
        waiterBtn.innerHTML = `Garson Ã‡aÄŸÄ±r (${usageLimits.call_waiter.remaining} kaldÄ±)`;
        waiterBtn.disabled = usageLimits.call_waiter.remaining <= 0;
      }

      if (charcoalBtn) {
        charcoalBtn.innerHTML = `KÃ¶z Ä°ste (${usageLimits.call_charcoal.remaining} kaldÄ±)`;
        charcoalBtn.disabled = usageLimits.call_charcoal.remaining <= 0;
      }
    }

    // DOM elementleri
    const menuGrid = document.getElementById('menuGrid');
    const categoryBar = document.getElementById('categoryBar');
    const orderList = document.getElementById('order-list');
    const toastContainer = document.getElementById('toast-container');
    const tableIdElement = document.getElementById('table-id');
    const restaurantNameElement = document.getElementById('restaurantName');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const callWaiterBtn = document.getElementById('callWaiterBtn');
    const kozIsteBtn = document.getElementById('kozIsteBtn');

    // Sayfa yÃ¼klendiÄŸinde baÅŸlat
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor...');
        await initializeApp();
      } catch (error) {
        console.error('âŒ Uygulama baÅŸlatÄ±lamadÄ±:', error);
        showToast('Uygulama yÃ¼klenirken hata oluÅŸtu', 'error');
      } finally {
        // YÃ¼kleme ekranÄ±nÄ± kaldÄ±r
        loadingOverlay.style.display = 'none';
      }
    });

    // UygulamayÄ± baÅŸlat
    async function initializeApp() {
      try {
        console.log('ğŸš€ Uygulama baÅŸlatÄ±lÄ±yor...');
        
        // KullanÄ±cÄ± oturumunu baÅŸlat
        const sessionInitialized = await initializeUserSession();
        if (!sessionInitialized) {
          showToast('Oturum baÅŸlatÄ±lamadÄ±!', 'error');
          return;
        }
        
        // Restoran ve masa bilgilerini al
        restaurantInfo = await getRestaurantInfo();
        tableInfo = await getTableInfo();
        
        console.log('ğŸ“‹ Restoran Bilgileri:', restaurantInfo);
        console.log('ğŸª‘ Masa Bilgileri:', tableInfo);
        
        if (!restaurantInfo || !tableInfo) {
          showToast('Restoran veya masa bilgileri bulunamadÄ±', 'error');
          return;
        }

        // ÃœrÃ¼nler ve kategorileri al
        products = await getProducts();
        categories = await getProductCategories();
        
        console.log('ğŸ½ï¸ ÃœrÃ¼nler:', products);
        console.log('ğŸ“‚ Kategoriler:', categories);

        // UI'yi gÃ¼ncelle
        updateUI();
        
        // Kategori barÄ±nÄ± oluÅŸtur
        createCategoryBar();
        
        // MenÃ¼yÃ¼ render et
        renderMenu();
        
        // SipariÅŸleri render et
        renderOrders();
        
        // Event listener'larÄ± ekle
        submitOrderBtn.addEventListener('click', submitOrder);
        callWaiterBtn.addEventListener('click', () => callWaiter('waiter'));
        kozIsteBtn.addEventListener('click', () => callWaiter('charcoal'));
        
        console.log('âœ… Uygulama baÅŸarÄ±yla baÅŸlatÄ±ldÄ±!');
        
      } catch (error) {
        console.error('âŒ Uygulama baÅŸlatma hatasÄ±:', error);
        showToast('Uygulama baÅŸlatÄ±lÄ±rken hata oluÅŸtu', 'error');
      }
    }

    // Restoran bilgilerini getir
    async function getRestaurantInfo() {
      console.log('ğŸ” getRestaurantInfo Ã§aÄŸrÄ±ldÄ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('restaurants')
          .select('*')
          .eq('id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('âœ… Restoran bilgileri alÄ±ndÄ±:', data);
        return data;
      } catch (error) {
        console.error('âŒ Restoran bilgileri alÄ±namadÄ±:', error);
        return null;
      }
    }

    // Masa bilgilerini getir
    async function getTableInfo() {
      console.log('ğŸ” getTableInfo Ã§aÄŸrÄ±ldÄ±, Table ID:', TABLE_ID);
      try {
        const { data, error } = await supabase
          .from('tables')
          .select('*')
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID)
          .single();

        if (error) throw error;
        console.log('âœ… Masa bilgileri alÄ±ndÄ±:', data);
        return data;
      } catch (error) {
        console.error('âŒ Masa bilgileri alÄ±namadÄ±:', error);
        return null;
      }
    }

    // RestoranÄ±n Ã¼rÃ¼nlerini getir
    async function getProducts() {
      console.log('ğŸ” getProducts Ã§aÄŸrÄ±ldÄ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .eq('is_active', true)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('âœ… ÃœrÃ¼nler alÄ±ndÄ±:', data);
        return data || [];
      } catch (error) {
        console.error('âŒ ÃœrÃ¼nler alÄ±namadÄ±:', error);
        return [];
      }
    }

    // ÃœrÃ¼n kategorilerini getir
    async function getProductCategories() {
      console.log('ğŸ” getProductCategories Ã§aÄŸrÄ±ldÄ±, Restaurant ID:', RESTAURANT_ID);
      try {
        const { data, error } = await supabase
          .from('product_categories')
          .select('*')
          .eq('restaurant_id', RESTAURANT_ID)
          .order('sort_order', { ascending: true });

        if (error) throw error;
        console.log('âœ… ÃœrÃ¼n kategorileri alÄ±ndÄ±:', data);
        return data || [];
      } catch (error) {
        console.error('âŒ ÃœrÃ¼n kategorileri alÄ±namadÄ±:', error);
        return [];
      }
    }

    // UI'yi gÃ¼ncelle
    function updateUI() {
      // Logo ve restoran adÄ±
      if (restaurantInfo) {
        restaurantNameElement.textContent = restaurantInfo.name || 'QR MenÃ¼';
      }
      
      // Masa numarasÄ±
      if (tableInfo) {
        tableIdElement.textContent = tableInfo.number || '--';
      }
    }

    // Kategori barÄ±nÄ± oluÅŸtur
    function createCategoryBar() {
      // TÃ¼mÃ¼ kategorisi
      const allCategoriesBtn = `
        <button class="category-btn active" data-key="all">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">TÃ¼mÃ¼</span>
        </button>
      `;
      
      // Kategorileri oluÅŸtur
      const categoryButtons = categories.map(cat => `
        <button class="category-btn" data-key="${cat.id}">
          <span class="cat-icon">${productIcons.default}</span>
          <span class="cat-name">${cat.name}</span>
        </button>
      `).join('');
      
      categoryBar.innerHTML = allCategoriesBtn + categoryButtons;
      
      // Kategori tÄ±klama olaylarÄ±
      categoryBar.addEventListener('click', e => {
        const btn = e.target.closest('.category-btn');
        if (!btn) return;
        
        const categoryId = btn.dataset.key;
        filterByCategory(categoryId);
        updateCategoryBar(categoryId);
      });
    }

    // Kategori barÄ±nÄ± gÃ¼ncelle
    function updateCategoryBar(activeCategoryId = 'all') {
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.key === activeCategoryId);
      });
    }

    // Kategoriye gÃ¶re filtrele
    function filterByCategory(categoryId) {
      let filteredProducts = products;
      
      if (categoryId !== 'all') {
        filteredProducts = products.filter(product => product.category_id === categoryId || product.category === categoryId);
      }
      
      renderMenu(filteredProducts);
    }

    // ÃœrÃ¼n adÄ±na gÃ¶re fotoÄŸraf dÃ¶ndÃ¼ren fonksiyon
    function getProductIcon(name) {
      if (!name) return productIcons.default;
      const key = name.toLowerCase()
        .replace(/Ä±/g, 'i')
        .replace(/Ã¼/g, 'u')
        .replace(/Ã¶/g, 'o')
        .replace(/ÅŸ/g, 's')
        .replace(/Ã§/g, 'c')
        .replace(/ÄŸ/g, 'g');
      return productIcons[key] || productIcons.default;
    }

    // MenÃ¼ kartlarÄ±nÄ± oluÅŸtur
    function renderMenu(productsToRender = products) {
      menuGrid.innerHTML = '';
      
      if (productsToRender.length === 0) {
        menuGrid.innerHTML = '<div class="no-products">Bu kategoride Ã¼rÃ¼n bulunamadÄ±.</div>';
        return;
      }
      
      productsToRender.forEach(product => {
        const card = document.createElement('div');
        card.className = 'menu-card glass';
        card.innerHTML = `
          <div class="menu-icon-svg">${getProductIcon(product.name)}</div>
          <div class="menu-info">
            <h3>${product.name}</h3>
            <p>${product.description || ''}</p>
            <div class="menu-bottom">
              <span class="menu-price">${product.price}${restaurantInfo?.currency || 'â‚º'}</span>
              <button class="neon-btn" data-id="${product.id}" data-price="${product.price}">
                SipariÅŸ Ver
              </button>
            </div>
          </div>
        `;
        menuGrid.appendChild(card);
      });
      
      // SipariÅŸ butonlarÄ±na tÄ±klama olaylarÄ±
      menuGrid.querySelectorAll('.neon-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const productId = btn.dataset.id;
          const product = products.find(p => p.id === productId);
          if (product) {
            addToOrder(product);
          }
        });
      });
    }

    // SipariÅŸ listesi
    function renderOrders() {
      orderList.innerHTML = '';
      
      if (orders.length === 0) {
        orderList.innerHTML = '<li>HenÃ¼z sipariÅŸ yok.</li>';
        return;
      }
      
      // ÃœrÃ¼nleri grupla ve miktarlarÄ± hesapla
      const groupedOrders = {};
      orders.forEach(item => {
        if (groupedOrders[item.id]) {
          groupedOrders[item.id].quantity += 1;
        } else {
          groupedOrders[item.id] = { ...item, quantity: 1 };
        }
      });
      
      // Toplam fiyatÄ± hesapla
      let totalPrice = 0;
      
      Object.values(groupedOrders).forEach(item => {
        const li = document.createElement('li');
        const itemTotal = parseFloat(item.price) * item.quantity;
        totalPrice += itemTotal;
        
        li.innerHTML = `
          <div class="order-item">
            <span class="item-name">${item.name}</span>
            <span class="item-quantity">x${item.quantity}</span>
            <span class="item-price">${itemTotal}${restaurantInfo?.currency || 'â‚º'}</span>
          </div>
        `;
        orderList.appendChild(li);
      });
      
      // Toplam fiyatÄ± gÃ¶ster
      if (totalPrice > 0) {
        const totalLi = document.createElement('li');
        totalLi.className = 'order-total';
        totalLi.innerHTML = `
          <div class="total-line">
            <span>Toplam:</span>
            <span class="total-price">${totalPrice}${restaurantInfo?.currency || 'â‚º'}</span>
          </div>
        `;
        orderList.appendChild(totalLi);
      }
    }

    // SipariÅŸe Ã¼rÃ¼n ekle
    function addToOrder(product) {
      orders.push(product);
      renderOrders();
      showToast(`${product.name} sipariÅŸe eklendi!`, 'success');
    }

    // SipariÅŸi gÃ¶nder
    async function submitOrder() {
      if (orders.length === 0) {
        showToast('SipariÅŸ listesi boÅŸ!', 'error');
        return;
      }

      // KullanÄ±m limiti kontrolÃ¼
      const canOrder = await checkUsageLimit('order');
      if (!canOrder) {
        showToast('GÃ¼nlÃ¼k sipariÅŸ limitiniz doldu! YarÄ±n tekrar deneyebilirsiniz.', 'error');
        return;
      }
      
      try {
        // Toplam fiyatÄ± hesapla
        const totalPrice = orders.reduce((sum, item) => sum + parseFloat(item.price), 0);
        
        // SipariÅŸ oluÅŸtur
        const { data, error } = await supabase
          .from('orders')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            status: 'pending',
            total_price: totalPrice,
            note: 'QR menÃ¼den sipariÅŸ'
          }])
          .select()
          .single();
        
        if (error) throw error;
        
        // SipariÅŸ kalemlerini ekle
        const groupedOrders = {};
        orders.forEach(item => {
          if (groupedOrders[item.id]) {
            groupedOrders[item.id].quantity += 1;
          } else {
            groupedOrders[item.id] = { ...item, quantity: 1 };
          }
        });
        
        for (const [productId, item] of Object.entries(groupedOrders)) {
          await supabase
            .from('order_items')
            .insert([{
              order_id: data.id,
              product_id: productId,
              quantity: item.quantity,
              unit_price: parseFloat(item.price),
              note: null
            }]);
        }
        
        // Masa durumunu gÃ¼ncelle
        await supabase
          .from('tables')
          .update({ status: 'active' })
          .eq('id', TABLE_ID)
          .eq('restaurant_id', RESTAURANT_ID);
        
        // SipariÅŸ listesini temizle
        orders = [];
        renderOrders();
        
        showToast('SipariÅŸiniz baÅŸarÄ±yla gÃ¶nderildi!', 'success');
        
      } catch (error) {
        console.error('âŒ SipariÅŸ gÃ¶nderilemedi:', error);
        showToast('SipariÅŸ gÃ¶nderilirken hata oluÅŸtu', 'error');
      }
    }

    // Garson Ã§aÄŸÄ±r
    async function callWaiter(callType = 'waiter') {
      // KullanÄ±m limiti kontrolÃ¼
      const actionType = callType === 'waiter' ? 'call_waiter' : 'call_charcoal';
      const canCall = await checkUsageLimit(actionType);
      
      if (!canCall) {
        const message = callType === 'waiter' 
          ? 'GÃ¼nlÃ¼k garson Ã§aÄŸÄ±rma limitiniz doldu! YarÄ±n tekrar deneyebilirsiniz.'
          : 'GÃ¼nlÃ¼k kÃ¶z isteme limitiniz doldu! YarÄ±n tekrar deneyebilirsiniz.';
        showToast(message, 'error');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('calls')
          .insert([{
            restaurant_id: RESTAURANT_ID,
            table_id: TABLE_ID,
            session_id: currentSessionId,
            type: callType === 'waiter' ? 'garson' : 'kÃ¶z',
            status: 'pending'
          }])
          .select()
          .single();

        if (error) throw error;
        
        if (callType === 'waiter') {
          showToast('Garson Ã§aÄŸrÄ±ldÄ±! LÃ¼tfen bekleyiniz.', 'info');
        } else if (callType === 'charcoal') {
          showToast('KÃ¶z isteÄŸiniz iletildi! LÃ¼tfen bekleyiniz.', 'info');
        }
        
        return data;
      } catch (error) {
        console.error('âŒ Ã‡aÄŸrÄ± oluÅŸturulamadÄ±:', error);
        showToast('Ã‡aÄŸrÄ± oluÅŸturulamadÄ±', 'error');
        throw error;
      }
    }

    // Toast bildirim fonksiyonu
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 600);
      }, 2500);
    }
  </script>
</body>
</html> 